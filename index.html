<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö-–°–∏—Å—Ç–µ–º–∞: –ö–∞—Å—Å–∞ –∏ –ë–∞–Ω–∫</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-light: #F2F6F9;
            --card-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --dark-blue: #2a5298;
            --accent-green: #27ae60;
            --text-main: #2C3E50;
            --white: #FFFFFF;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Inter', -apple-system, sans-serif; background: var(--bg-light); color: var(--text-main); }

        /* --- –≠–ö–†–ê–ù –ö–õ–ò–ï–ù–¢–ê (–û–ü–õ–ê–¢–ê) --- */
        #client-screen {
            display: none; min-height: 100vh; padding: 25px; flex-direction: column; align-items: center;
        }
        .bank-header { width: 100%; display: flex; justify-content: space-between; margin-bottom: 30px; font-weight: 900; }
        
        .card-visual {
            width: 100%; max-width: 350px; height: 210px; background: var(--card-gradient);
            border-radius: 28px; padding: 30px; color: white; position: relative;
            box-shadow: 0 20px 40px rgba(42, 82, 152, 0.25); margin-bottom: 40px;
        }
        .card-chip { width: 50px; height: 38px; background: linear-gradient(135deg, #f1c40f, #f39c12); border-radius: 8px; margin-bottom: 25px; }
        .pay-val { font-size: 36px; font-weight: 800; }

        .input-box { width: 100%; max-width: 350px; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); }
        .input-box input {
            width: 100%; padding: 18px; border-radius: 16px; border: 2px solid #F0F3F7;
            background: #F8FAFC; font-size: 18px; margin-top: 10px; text-align: center;
        }
        .btn-confirm {
            width: 100%; background: var(--dark-blue); color: white; border: none; padding: 20px;
            border-radius: 18px; font-size: 16px; font-weight: 800; margin-top: 25px; cursor: pointer;
        }

        /* --- –≠–ö–†–ê–ù –ö–ê–°–°–ò–†–ê --- */
        #cashier-screen { display: block; padding: 20px; }
        .pos-card { background: white; border-radius: 25px; padding: 20px; margin-bottom: 20px; }
        .terminal-overlay {
            display: none; position: fixed; inset: 0; background: #000; z-index: 100;
            flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        #qr-code { background: white; padding: 15px; border-radius: 20px; margin: 20px 0; }
        
        .pos-btn { background: #E2E8F0; border: none; padding: 15px; border-radius: 15px; font-weight: 600; cursor: pointer; }
    </style>
</head>
<body>

    <div id="client-screen">
        <div class="bank-header">–ö-–û–ù–õ–ê–ô–ù <span>‚óè FASTPAY</span></div>
        
        <div class="card-visual">
            <div class="card-chip"></div>
            <div style="font-size: 12px; opacity: 0.7; text-transform: uppercase;">–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</div>
            <div class="pay-val" id="client-amount">0.00 ‚ÇΩ</div>
            <div style="position:absolute; bottom:30px; right:30px; opacity:0.5; font-size:12px;">SECURE TERMINAL</div>
        </div>

        <div class="input-box">
            <label style="font-size:12px; font-weight:700; color:#888;">–í–ê–® TELEGRAM ID</label>
            <input type="number" id="client-id" placeholder="–ù–∞–ø—Ä: 6348425176">
            <button class="btn-confirm" onclick="payNow()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨ –û–ü–õ–ê–¢–£</button>
        </div>
        <div style="margin-top:auto; font-size:11px; color:#A0AEC0;">üîí Encrypted by K-Bank Security Systems</div>
    </div>

    <div id="cashier-screen">
        <h2 style="margin-bottom:20px;">–ö-–ö–∞—Å—Å–∞ PRO</h2>
        
        <div class="pos-card">
            <div id="cart-list" style="min-height:80px; font-size:14px; color:#666;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...</div>
            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
            <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:800;">
                –ò—Ç–æ–≥–æ: <span id="pos-total">0 ‚ÇΩ</span>
            </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="pos-btn" onclick="add('–ü–∏—Ü—Ü–∞', 650)">üçï –ü–∏—Ü—Ü–∞</button>
            <button class="pos-btn" onclick="add('–†–æ–ª–ª—ã', 480)">üç£ –†–æ–ª–ª—ã</button>
            <button class="pos-btn" onclick="add('–ö–æ—Ñ–µ', 150)">‚òï –ö–æ—Ñ–µ</button>
            <button class="pos-btn" onclick="add('–®–∞—É—Ä–º–∞', 250)">üåØ –®–∞–≤—É—Ö–∞</button>
        </div>

        <button class="btn-confirm" style="margin-top:20px;" onclick="showQR()">–°–§–û–†–ú–ò–†–û–í–ê–¢–¨ QR</button>
    </div>

    <div class="terminal-overlay" id="term-ui">
        <div style="font-size:14px; opacity:0.6;">–û–ñ–ò–î–ê–ù–ò–ï –û–ü–õ–ê–¢–´</div>
        <div id="qr-amount" style="font-size:40px; font-weight:900; margin:10px 0;">0 ‚ÇΩ</div>
        <div id="qr-code"></div>
        <p style="text-align:center; padding:0 40px; font-size:14px;">–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –∫–∞–º–µ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
        <button class="pos-btn" style="background:#333; color:white; width:200px;" onclick="location.reload()">–û–¢–ú–ï–ù–ê</button>
    </div>

<script>
    // –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE
    const config = { databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(config);
    const rtdb = firebase.database();

    let total = 0;
    let cart = [];

    // 1. –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –†–û–õ–ò
    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        const amount = params.get('amount');

        if (amount) {
            document.getElementById('cashier-screen').style.display = 'none';
            document.getElementById('client-screen').style.display = 'flex';
            document.getElementById('client-amount').innerText = amount + " ‚ÇΩ";
            window.payTarget = parseInt(amount);
            
            // –ê–≤—Ç–æ-–≤—Ö–æ–¥ —á–µ—Ä–µ–∑ Telegram Mini App
            if (window.Telegram && window.Telegram.WebApp) {
                const user = window.Telegram.WebApp.initDataUnsafe.user;
                if (user) document.getElementById('client-id').value = user.id;
            }
        }
    };

    // 2. –õ–û–ì–ò–ö–ê –ö–ê–°–°–´
    function add(n, p) {
        cart.push(n);
        total += p;
        document.getElementById('cart-list').innerText = cart.join(', ');
        document.getElementById('pos-total').innerText = total + " ‚ÇΩ";
    }

    function showQR() {
        if (total === 0) return;
        document.getElementById('term-ui').style.display = 'flex';
        document.getElementById('qr-amount').innerText = total + " ‚ÇΩ";
        
        const link = window.location.href.split('?')[0] + "?amount=" + total;
        new QRCode(document.getElementById("qr-code"), { text: link, width: 200, height: 200 });
    }

    // 3. –õ–û–ì–ò–ö–ê –ë–ê–ù–ö–ê (–ö–õ–ò–ï–ù–¢)
    function payNow() {
        const id = document.getElementById('client-id').value;
        if (!id) return alert("–í–≤–µ–¥–∏—Ç–µ ID");

        rtdb.ref('clients').once('value', (snap) => {
            const users = snap.val();
            let uKey = null; let uData = null;

            for (let k in users) {
                if (String(users[k].telegramId) === id) {
                    uKey = k; uData = users[k]; break;
                }
            }

            if (!uData) return alert("–ê–∫–∫–∞—É–Ω—Ç –ö-–û–Ω–ª–∞–π–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω");
            if (uData.balance < window.payTarget) return alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤");

            const newBal = uData.balance - window.payTarget;
            rtdb.ref(`clients/${uKey}`).update({ balance: newBal }).then(() => {
                rtdb.ref(`history/${uKey}`).push({
                    title: 'QR –û–ø–ª–∞—Ç–∞: –ú–∞–≥–∞–∑–∏–Ω', val: window.payTarget, type: 'minus', ico: 'üí≥', date: new Date().toLocaleString()
                });
                
                if (window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                
                document.body.innerHTML = `
                    <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:white;">
                        <div style="font-size:80px;">‚úÖ</div>
                        <h2 style="margin:20px 0 10px;">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞</h2>
                        <p style="color:#888;">–ö-–û–Ω–ª–∞–π–Ω FastPay</p>
                        <button onclick="location.href='index.html'" style="margin-top:30px; border:none; background:none; color:blue; font-weight:bold;">–í–µ—Ä–Ω—É—Ç—å—Å—è</button>
                    </div>`;
            });
        });
    }
</script>
</body>
</html>
