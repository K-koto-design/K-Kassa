<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö-–§—Ä–µ—à: POS –°–∏—Å—Ç–µ–º–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg: #F2F6F9;
            --dark: #1A1A1A;
            --blue: #2a5298;
            --green: #27ae60;
            --white: #ffffff;
        }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--dark); overflow-x: hidden; }

        /* --- –°–ï–¢–ö–ê –¢–û–í–ê–†–û–í (–ö–ê–°–°–ò–†) --- */
        .pos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; }
        .product-btn { 
            background: var(--white); border: none; padding: 15px; border-radius: 18px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); font-weight: 600; text-align: left;
            display: flex; flex-direction: column;
        }
        .product-btn span { font-size: 20px; margin-bottom: 5px; }

        /* --- –≠–ö–†–ê–ù –ü–û–ö–£–ü–ê–¢–ï–õ–Ø (–ö–õ–ò–ï–ù–¢-–¢–ê–ë–õ–û) --- */
        #display-screen {
            display: none; height: 100vh; background: var(--white);
            flex-direction: column; padding: 30px;
        }
        .bill-card {
            background: var(--bg); border-radius: 30px; padding: 25px; flex: 1;
            display: flex; flex-direction: column;
        }
        #qr-area { background: white; padding: 15px; border-radius: 20px; margin: 20px auto; width: 180px; }

        /* --- –û–ë–©–ò–ï –≠–õ–ï–ú–ï–ù–¢–´ --- */
        .btn-action {
            width: 100%; padding: 20px; border-radius: 20px; border: none;
            font-size: 18px; font-weight: 800; cursor: pointer; margin-top: 10px;
        }
        .success-overlay {
            display: none; position: fixed; inset: 0; background: var(--green);
            color: white; z-index: 1000; align-items: center; justify-content: center;
            flex-direction: column; text-align: center;
        }
    </style>
</head>
<body>

    <div id="cashier-ui">
        <div style="padding: 20px; display: flex; justify-content: space-between;">
            <h2 style="margin:0">–ö-–§—Ä–µ—à –ö–∞—Å—Å–∞</h2>
            <button onclick="switchToDisplay()" style="border:none; background:none; color:var(--blue);">–≠–∫—Ä–∞–Ω –ø–æ–∫—É–ø–∞—Ç–µ–ª—è ‚û°Ô∏è</button>
        </div>

        <div class="pos-grid" id="menu-grid"></div>

        <div style="background:var(--dark); color:white; padding:25px; border-radius:30px 30px 0 0; position:fixed; bottom:0; width:100%;">
            <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:800; margin-bottom:15px;">
                <span>–ò—Ç–æ–≥–æ:</span> <span id="total-val">0 ‚ÇΩ</span>
            </div>
            <button class="btn-action" style="background:var(--blue); color:white;" onclick="startPayment()">–ü–†–ò–ù–Ø–¢–¨ –û–ü–õ–ê–¢–£</button>
            <button class="btn-action" style="background:#444; color:white; font-size:14px;" onclick="clearCheck()">–û–ß–ò–°–¢–ò–¢–¨ –ß–ï–ö</button>
        </div>
    </div>

    <div id="display-screen">
        <h1>–í–∞—à –∑–∞–∫–∞–∑</h1>
        <div class="bill-card">
            <div id="display-items" style="flex:1; overflow-y:auto;"></div>
            <div style="text-align:center;">
                <div style="font-size:32px; font-weight:900;" id="display-total">0 ‚ÇΩ</div>
                <div id="qr-area"></div>
                <div style="opacity:0.5; font-size:14px;">–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –ö-–ë–∞–Ω–∫–æ–º –¥–ª—è –æ–ø–ª–∞—Ç—ã</div>
            </div>
        </div>
    </div>

    <div id="success-screen" class="success-overlay">
        <div style="font-size:80px;">‚úÖ</div>
        <h1 id="success-msg">–û–ü–õ–ê–ß–ï–ù–û –£–°–ü–ï–®–ù–û</h1>
        <div id="print-btns" style="display:none; width:80%;">
            <button class="btn-action" style="background:white; color:black;" onclick="printReceipt('FunPrint')">–ü–µ—á–∞—Ç—å FunPrint</button>
            <button class="btn-action" style="background:white; color:black;" onclick="printReceipt('WalkPrint')">–ü–µ—á–∞—Ç—å WalkPrint</button>
            <button class="btn-action" style="background:none; color:white;" onclick="location.reload()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

<script>
    const config = { databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(config);
    const rtdb = firebase.database();

    const menu = [
        { n: '–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏', p: 650, i: 'üçï', c: 'pizza' },
        { n: '–ü–∏—Ü—Ü–∞ 4 –°—ã—Ä–∞', p: 720, i: 'üßÄ', c: 'pizza' },
        { n: '–†–æ–ª–ª –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', p: 480, i: 'üç£', c: 'rolls' },
        { n: '–®–∞—É—Ä–º–∞ XXL', p: 320, i: 'üåØ', c: 'shaurma' },
        { n: '–ë—É—Ä–≥–µ—Ä –®–µ—Ñ', p: 450, i: 'üçî', c: 'burgers' },
        { n: '–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –§—Ä–∏', p: 150, i: 'üçü', c: 'side' },
        { n: '–ö–∞–ø—É—á–∏–Ω–æ', p: 180, i: '‚òï', c: 'drinks' },
        { n: '–ö–æ–ª–∞ 0.5', p: 95, i: 'ü•§', c: 'drinks' },
        { n: '–ß–∏–∑–∫–µ–π–∫', p: 280, i: 'üç∞', c: 'dessert' },
        { n: '–°—É—à–∏ –°–µ—Ç', p: 1200, i: 'üç±', c: 'rolls' }
    ];

    let currentCheck = { items: [], total: 0, status: 'waiting' };

    // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ö–ê–°–°–´
    window.onload = () => {
        const grid = document.getElementById('menu-grid');
        menu.forEach(item => {
            grid.innerHTML += `
                <button class="product-btn" onclick="addToCheck('${item.n}', ${item.p})">
                    <span>${item.i}</span>
                    <div>${item.n}</div>
                    <div style="color:var(--blue)">${item.p} ‚ÇΩ</div>
                </button>`;
        });

        // –°–ª—É—à–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ–∫–∞ (–¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è –∏ —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã)
        rtdb.ref('current_check').on('value', (snap) => {
            const data = snap.val();
            if(!data) return;
            
            updateDisplay(data);
            
            if(data.status === 'paid') {
                showSuccess(true);
            }
        });
    };

    function addToCheck(n, p) {
        currentCheck.items.push({n, p});
        currentCheck.total += p;
        sync();
    }

    function sync() {
        rtdb.ref('current_check').set(currentCheck);
        document.getElementById('total-val').innerText = currentCheck.total + " ‚ÇΩ";
    }

    function clearCheck() {
        currentCheck = { items: [], total: 0, status: 'waiting' };
        sync();
    }

    function switchToDisplay() {
        document.getElementById('cashier-ui').style.display = 'none';
        document.getElementById('display-screen').style.display = 'flex';
    }

    // –û–ë–ù–û–í–õ–ï–ù–ò–ï –¢–ê–ë–õ–û –ü–û–ö–£–ü–ê–¢–ï–õ–Ø
    function updateDisplay(data) {
        const list = document.getElementById('display-items');
        const totalDisp = document.getElementById('display-total');
        const qrArea = document.getElementById('qr-area');

        list.innerHTML = data.items.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><span>${i.n}</span><b>${i.p} ‚ÇΩ</b></div>`).join('');
        totalDisp.innerText = data.total + " ‚ÇΩ";

        if(data.total > 0 && data.status === 'waiting') {
            qrArea.innerHTML = '';
            // –°—Å—ã–ª–∫–∞ –≤–µ–¥–µ—Ç –Ω–∞ —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–∞ (–∫–∞–∫ –º—ã –¥–µ–ª–∞–ª–∏ —Ä–∞–Ω—å—à–µ)
            const payLink = window.location.href.split('?')[0] + "?pay=" + data.total;
            new QRCode(qrArea, { text: payLink, width: 150, height: 150 });
        }
    }

    function showSuccess(isPaid) {
        const screen = document.getElementById('success-screen');
        screen.style.display = 'flex';
        // –ï—Å–ª–∏ —ç—Ç–æ –∫–∞—Å—Å–∏—Ä, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—á–∞—Ç–∏
        if(document.getElementById('cashier-ui').style.display !== 'none') {
            document.getElementById('print-btns').style.display = 'block';
        }
    }

    // –û–ü–õ–ê–¢–ê (–ò–º–∏—Ç–∞—Ü–∏—è –∏–ª–∏ —Ä–µ–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
    function startPayment() {
        // –ó–¥–µ—Å—å –∫–∞—Å—Å–∏—Ä –º–æ–∂–µ—Ç —Å–∞–º –Ω–∞–∂–∞—Ç—å, –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –ø–ª–∞—Ç–∏—Ç –Ω–∞–ª–∏—á–∫–æ–π
        rtdb.ref('current_check').update({ status: 'paid' });
    }

    // –°–ò–°–¢–ï–ú–ê –ü–ï–ß–ê–¢–ò
    function printReceipt(app) {
        const date = new Date().toLocaleString();
        let text = `–ö-–§–†–ï–® –ß–ï–ö\n----------\n`;
        currentCheck.items.forEach(i => text += `${i.n} - ${i.p}—Ä\n`);
        text += `----------\n–ò–¢–û–ì–û: ${currentCheck.total}—Ä\n–î–∞—Ç–∞: ${date}\n–°–ü–ê–°–ò–ë–û –ó–ê –ü–û–ö–£–ü–ö–£!`;
        
        window.location.href = (app === 'FunPrint' ? 'funprint' : 'walkprint') + "://print?text=" + encodeURIComponent(text);
        setTimeout(() => clearCheck(), 2000);
    }

    // –õ–û–ì–ò–ö–ê –û–ü–õ–ê–¢–´ –ö–õ–ò–ï–ù–¢–û–ú (—á–µ—Ä–µ–∑ QR)
    const urlParams = new URLSearchParams(window.location.search);
    if(urlParams.get('pay')) {
        const amount = urlParams.get('pay');
        document.body.innerHTML = `
            <div style="padding:40px; text-align:center; background:var(--blue); color:white; height:100vh;">
                <h1>–ö-–ë–ê–ù–ö –û–ü–õ–ê–¢–ê</h1>
                <div style="font-size:48px; margin:40px 0;">${amount} ‚ÇΩ</div>
                <input type="number" id="client-id" placeholder="–í–∞—à ID" style="width:100%; padding:20px; border-radius:15px; border:none; text-align:center; font-size:20px;">
                <button onclick="clientPay(${amount})" style="width:100%; padding:20px; background:var(--green); color:white; border:none; border-radius:15px; font-weight:bold; margin-top:20px; font-size:18px;">–û–ü–õ–ê–¢–ò–¢–¨</button>
            </div>`;
    }

    function clientPay(amt) {
        const id = document.getElementById('client-id').value;
        rtdb.ref('clients').once('value', (snap) => {
            const users = snap.val();
            let found = null; let fKey = null;
            for(let k in users) { if(String(users[k].telegramId) === id) { found = users[k]; fKey = k; } }

            if(found && found.balance >= amt) {
                rtdb.ref(`clients/${fKey}`).update({ balance: found.balance - amt }).then(() => {
                    rtdb.ref('current_check').update({ status: 'paid' });
                    document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>‚úÖ –û–ü–õ–ê–ß–ï–ù–û</h1>";
                });
            } else { alert("–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã"); }
        });
    }
</script>
</body>
</html>
