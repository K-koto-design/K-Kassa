<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö-–§–†–ï–® POS</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --bg: #F2F6F9; --blue: #2a5298; --dark: #1A1A1A; --green: #27ae60; }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--dark); }

        .screen { display: none; min-height: 100vh; flex-direction: column; }
        .active { display: flex; }

        /* –ö–ê–°–°–ò–† */
        .pos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; padding-bottom: 220px; }
        .product-btn { 
            background: white; border: none; padding: 15px; border-radius: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: left; cursor: pointer;
        }
        .product-btn:active { background: #eee; }
        .product-btn span { font-size: 24px; display: block; }
        .product-btn b { color: var(--blue); display: block; margin-top: 5px; }

        /* –§–£–¢–ï–† –ö–ê–°–°–´ */
        .footer { position: fixed; bottom: 0; width: 100%; background: var(--dark); padding: 20px; border-radius: 25px 25px 0 0; color: white; }
        .btn-main { width: 100%; padding: 18px; border-radius: 15px; border: none; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }

        /* –≠–ö–†–ê–ù –ö–õ–ò–ï–ù–¢–ê */
        .customer-area { padding: 25px; flex: 1; display: flex; flex-direction: column; }
        .check-box { background: white; border-radius: 25px; padding: 20px; flex: 1; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        #qrcode { background: white; padding: 10px; border-radius: 10px; margin: 15px auto; width: 150px; }
    </style>
</head>
<body>

    <div id="screen-cashier" class="screen active">
        <div style="padding: 20px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">–ö-–§–†–ï–® ü•ó</h2>
            <button onclick="showScreen('customer')" style="color:var(--blue); border:none; background:none; font-weight:bold;">–¢–ê–ë–õ–û –ö–õ–ò–ï–ù–¢–ê ‚û°Ô∏è</button>
        </div>
        
        <div class="pos-grid" id="menu-container">
            </div>

        <div class="footer">
            <div style="display:flex; justify-content:space-between; font-size:22px; font-weight:bold;">
                <span>–ò—Ç–æ–≥–æ:</span> <span id="cashier-total">0 ‚ÇΩ</span>
            </div>
            <button class="btn-main" style="background:var(--blue); color:white;" onclick="setPayStatus()">–í–´–°–¢–ê–í–ò–¢–¨ –°–ß–ï–¢</button>
            <button class="btn-main" style="background:#333; color:#777;" onclick="resetAll()">–°–ë–†–û–°</button>
        </div>
    </div>

    <div id="screen-customer" class="screen">
        <div class="customer-area">
            <h1 onclick="showScreen('cashier')">–í–∞—à –∑–∞–∫–∞–∑</h1>
            <div class="check-box" id="customer-list">
                <p style="text-align:center; opacity:0.3; margin-top:50px;">–û–∂–∏–¥–∞–Ω–∏–µ –∫–∞—Å—Å–∏—Ä–∞...</p>
            </div>
            <div style="text-align:center;">
                <div style="font-size:40px; font-weight:900;" id="customer-total">0 ‚ÇΩ</div>
                <div id="qrcode"></div>
                <p id="status-msg" style="color:var(--blue); font-weight:bold;">–û–ø–ª–∞—Ç–∞ –ø–æ QR</p>
            </div>
        </div>
    </div>

    <div id="success-overlay" style="display:none; position:fixed; inset:0; background:var(--green); z-index:999; color:white; flex-direction:column; align-items:center; justify-content:center;">
        <div style="font-size:100px;">‚úÖ</div>
        <h1>–û–ü–õ–ê–ß–ï–ù–û</h1>
        <button class="btn-main" style="width:80%; background:white;" onclick="printCheck('FunPrint')">–ß–µ–∫ FunPrint</button>
        <button class="btn-main" style="width:80%; background:white;" onclick="printCheck('WalkPrint')">–ß–µ–∫ WalkPrint</button>
        <p onclick="resetAll()" style="margin-top:20px; cursor:pointer;">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</p>
    </div>

<script>
    const config = { databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(config);
    const rtdb = firebase.database();

    const menu = [
        {n:'–ü–µ–ø–ø–µ—Ä–æ–Ω–∏', p:650, i:'üçï'}, {n:'4 –°—ã—Ä–∞', p:720, i:'üßÄ'},
        {n:'–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', p:480, i:'üç£'}, {n:'–î—Ä–∞–∫–æ–Ω', p:550, i:'üêâ'},
        {n:'–®–∞—É—Ä–º–∞ XXL', p:320, i:'üåØ'}, {n:'–ë—É—Ä–≥–µ—Ä', p:390, i:'üçî'},
        {n:'–§—Ä–∏', p:150, i:'üçü'}, {n:'–ù–∞–≥–≥–µ—Ç—Å—ã', p:220, i:'üçó'},
        {n:'–ö–æ—Ñ–µ', p:180, i:'‚òï'}, {n:'–ö–æ–ª–∞', p:95, i:'ü•§'}
    ];

    let order = { items: [], total: 0, status: 'wait' };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –º–µ–Ω—é
    const container = document.getElementById('menu-container');
    menu.forEach((item, index) => {
        container.innerHTML += `
            <button class="product-btn" onclick="addItem(${index})">
                <span>${item.i}</span> ${item.n} <b>${item.p} ‚ÇΩ</b>
            </button>`;
    });

    function addItem(idx) {
        const item = menu[idx];
        order.items.push(item);
        order.total += item.p;
        sync();
    }

    function sync() {
        rtdb.ref('current_check').set(order);
    }

    function setPayStatus() {
        if(order.total === 0) return;
        order.status = 'paying';
        sync();
    }

    function resetAll() {
        rtdb.ref('current_check').set({ items: [], total: 0, status: 'wait' }).then(() => {
            location.reload();
        });
    }

    function showScreen(s) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById('screen-' + s).classList.add('active');
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π
    rtdb.ref('current_check').on('value', (snap) => {
        const data = snap.val();
        if(!data) return;
        order = data; // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∞—Ö –∫–∞—Å—Å—ã
        document.getElementById('cashier-total').innerText = data.total + " ‚ÇΩ";

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–æ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è
        const list = document.getElementById('customer-list');
        if(data.items && data.items.length > 0) {
            list.innerHTML = data.items.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>${i.n}</span><b>${i.p} ‚ÇΩ</b></div>`).join('');
        } else {
            list.innerHTML = '<p style="text-align:center; opacity:0.3; margin-top:50px;">–û–∂–∏–¥–∞–Ω–∏–µ –∫–∞—Å—Å–∏—Ä–∞...</p>';
        }
        document.getElementById('customer-total').innerText = data.total + " ‚ÇΩ";

        // QR –∫–æ–¥
        const qrDiv = document.getElementById('qrcode');
        if(data.status === 'paying') {
            qrDiv.innerHTML = '';
            const link = window.location.href.split('?')[0] + "?pay=" + data.total;
            new QRCode(qrDiv, { text: link, width: 150, height: 150 });
        } else {
            qrDiv.innerHTML = '';
        }

        // –£—Å–ø–µ—Ö
        if(data.status === 'paid') {
            document.getElementById('success-overlay').style.display = 'flex';
        }
    });

    // –õ–æ–≥–∏–∫–∞ –ø–µ—á–∞—Ç–∏
    function printCheck(app) {
        let text = "   K-FRESH\n   -------\n";
        order.items.forEach(i => text += `${i.n} - ${i.p}—Ä\n`);
        text += `-------\n–ò–¢–û–ì–û: ${order.total}—Ä\n–°–ü–ê–°–ò–ë–û!`;
        window.location.href = (app === 'FunPrint' ? 'funprint' : 'walkprint') + "://print?text=" + encodeURIComponent(text);
    }

    // –õ–û–ì–ò–ö–ê –û–ü–õ–ê–¢–´ (–î–õ–Ø –ö–õ–ò–ï–ù–¢–ê)
    const p = new URLSearchParams(window.location.search);
    if(p.get('pay')) {
        const amt = p.get('pay');
        document.body.innerHTML = `
            <div style="padding:40px; text-align:center; background:#2a5298; color:white; height:100vh; display:flex; flex-direction:column; justify-content:center;">
                <h2>–ö-–û–ù–õ–ê–ô–ù –ë–ê–ù–ö</h2>
                <div style="font-size:60px; font-weight:900; margin:20px 0;">${amt} ‚ÇΩ</div>
                <input type="number" id="id" placeholder="–í–∞—à ID" style="width:100%; padding:20px; border-radius:15px; border:none; text-align:center; font-size:24px;">
                <button onclick="doPay(${amt})" style="width:100%; padding:20px; background:#27ae60; color:white; border:none; border-radius:15px; font-weight:bold; margin-top:20px; font-size:20px;">–û–ü–õ–ê–¢–ò–¢–¨</button>
            </div>`;
    }

    function doPay(a) {
        const id = document.getElementById('id').value;
        rtdb.ref('clients').once('value', (s) => {
            const us = s.val();
            let uk = null; let ud = null;
            for(let k in us) { if(String(us[k].telegramId) === id) { ud = us[k]; uk = k; } }
            if(ud && ud.balance >= a) {
                rtdb.ref(`clients/${uk}`).update({ balance: ud.balance - a }).then(() => {
                    rtdb.ref('current_check').update({ status: 'paid' });
                    document.body.innerHTML = "<h1 style='text-align:center; color:white; margin-top:100px;'>‚úÖ –û–ü–õ–ê–ß–ï–ù–û</h1>";
                });
            } else { alert("–û—à–∏–±–∫–∞!"); }
        });
    }
</script>
</body>
</html>
