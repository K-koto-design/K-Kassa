<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ö-–§–†–ï–® POS SYSTEM</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --bg: #F2F6F9; --dark: #1A1A1A; --blue: #2a5298; --green: #27ae60; --white: #ffffff; }
        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--dark); }

        /* –≠–ö–†–ê–ù–´ */
        .screen { display: none; min-height: 100vh; flex-direction: column; }
        .active { display: flex; }

        /* –ö–ê–°–°–ò–† */
        .pos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 15px; padding-bottom: 220px; }
        .product-btn { 
            background: var(--white); border: none; padding: 15px; border-radius: 20px; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); text-align: left; transition: 0.2s;
        }
        .product-btn:active { transform: scale(0.95); }
        .product-btn b { display: block; font-size: 18px; margin-top: 5px; color: var(--blue); }

        /* –¢–ê–ë–õ–û –ü–û–ö–£–ü–ê–¢–ï–õ–Ø */
        .customer-display { padding: 30px; background: white; flex: 1; }
        .bill-area { background: var(--bg); border-radius: 30px; padding: 25px; flex: 1; margin-bottom: 20px; }
        .item-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 18px; }

        /* –ö–ù–û–ü–ö–ò */
        .footer-panel { position: fixed; bottom: 0; width: 100%; background: var(--dark); padding: 25px; border-radius: 30px 30px 0 0; color: white; }
        .btn-main { width: 100%; padding: 18px; border-radius: 18px; border: none; font-size: 18px; font-weight: 800; cursor: pointer; margin-top: 10px; }
        
        #qrcode { background: white; padding: 10px; border-radius: 15px; margin: 20px auto; width: 150px; height: 150px; }
    </style>
</head>
<body>

    <div id="screen-cashier" class="screen active">
        <div style="padding: 20px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">–ö-–§–†–ï–® ü•ó</h2>
            <button onclick="changeScreen('customer')" style="background:none; border:none; color:var(--blue); font-weight:bold;">–¢–ê–ë–õ–û –ö–õ–ò–ï–ù–¢–ê ‚û°Ô∏è</button>
        </div>
        <div class="pos-grid" id="menu"></div>
        <div class="footer-panel">
            <div style="display:flex; justify-content:space-between; font-size:24px; font-weight:bold; margin-bottom:10px;">
                <span>–°—É–º–º–∞:</span> <span id="cashier-total">0 ‚ÇΩ</span>
            </div>
            <button class="btn-main" style="background:var(--blue); color:white;" onclick="setStatus('paying')">–í–´–°–¢–ê–í–ò–¢–¨ –°–ß–ï–¢</button>
            <button class="btn-main" style="background:#333; color:#888; font-size:14px;" onclick="resetOrder()">–°–ë–†–û–°–ò–¢–¨</button>
        </div>
    </div>

    <div id="screen-customer" class="screen">
        <div class="customer-display">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>–í–∞—à –∑–∞–∫–∞–∑</h1>
                <button onclick="changeScreen('cashier')" style="opacity:0.2; border:none; background:none;">POS</button>
            </div>
            <div class="bill-area" id="customer-items">
                <p style="text-align:center; opacity:0.3; margin-top:50px;">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...</p>
            </div>
            <div style="text-align:center;">
                <div style="font-size:40px; font-weight:900;" id="customer-total">0 ‚ÇΩ</div>
                <div id="qrcode"></div>
                <p id="status-text" style="font-weight:bold; color:var(--blue);">–û–ø–ª–∞—Ç–∞ —á–µ—Ä–µ–∑ –ö-–û–Ω–ª–∞–π–Ω</p>
            </div>
        </div>
    </div>

    <div id="success-overlay" style="display:none; position:fixed; inset:0; background:var(--green); z-index:9999; color:white; flex-direction:column; align-items:center; justify-content:center;">
        <div style="font-size:100px;">‚úÖ</div>
        <h1>–û–ü–õ–ê–ß–ï–ù–û</h1>
        <div id="print-zone" style="width:80%; margin-top:20px;">
            <button class="btn-main" style="background:white; color:black;" onclick="printCheck('FunPrint')">–ß–µ–∫ –≤ FunPrint</button>
            <button class="btn-main" style="background:white; color:black;" onclick="printCheck('WalkPrint')">–ß–µ–∫ –≤ WalkPrint</button>
            <button class="btn-main" style="background:none; color:white; border:1px solid white;" onclick="resetOrder()">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
        </div>
    </div>

<script>
    const config = { databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(config);
    const rtdb = firebase.database();

    const menuData = [
        {n:'–ü–∏—Ü—Ü–∞ –ü–µ–ø–ø–µ—Ä–æ–Ω–∏', p:650, i:'üçï'}, {n:'–ü–∏—Ü—Ü–∞ 4 –°—ã—Ä–∞', p:720, i:'üßÄ'},
        {n:'–†–æ–ª–ª –§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', p:480, i:'üç£'}, {n:'–†–æ–ª–ª –î—Ä–∞–∫–æ–Ω', p:550, i:'üêâ'},
        {n:'–®–∞—É—Ä–º–∞ XXL', p:320, i:'üåØ'}, {n:'–ë—É—Ä–≥–µ—Ä –ö–ª–∞—Å—Å–∏–∫', p:390, i:'üçî'},
        {n:'–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å –§—Ä–∏', p:150, i:'üçü'}, {n:'–ù–∞–≥–≥–µ—Ç—Å—ã', p:220, i:'üçó'},
        {n:'–ö–∞–ø—É—á–∏–Ω–æ', p:180, i:'‚òï'}, {n:'–ö–æ–ª–∞ 0.5', p:95, i:'ü•§'}
    ];

    let currentOrder = { items: [], total: 0, status: 'waiting' };

    // 1. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –≠–ö–†–ê–ù–û–í
    function changeScreen(type) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + type).classList.add('active');
    }

    // 2. –õ–û–ì–ò–ö–ê –ö–ê–°–°–ò–†–ê
    const menuBox = document.getElementById('menu');
    menuData.forEach(item => {
        const btn = document.createElement('button');
        btn.className = 'product-btn';
        btn.innerHTML = `<span>${item.i}</span> ${item.n} <b>${item.p} ‚ÇΩ</b>`;
        btn.onclick = () => {
            currentOrder.items.push(item);
            currentOrder.total += item.p;
            sync();
        };
        menuBox.appendChild(btn);
    });

    function sync() {
        rtdb.ref('current_check').set(currentOrder);
    }

    function setStatus(s) {
        currentOrder.status = s;
        sync();
    }

    function resetOrder() {
        currentOrder = { items: [], total: 0, status: 'waiting' };
        sync();
        location.reload();
    }

    // 3. –°–õ–£–®–ê–¢–ï–õ–¨ –ë–ê–ó–´ (–†–ê–ë–û–¢–ê–ï–¢ –ù–ê –û–ë–û–ò–• –≠–ö–†–ê–ù–ê–•)
    rtdb.ref('current_check').on('value', (snap) => {
        const data = snap.val();
        if(!data) return;

        // –û–±–Ω–æ–≤–ª—è–µ–º –ö–∞—Å—Å–∏—Ä–∞
        document.getElementById('cashier-total').innerText = data.total + " ‚ÇΩ";

        // –û–±–Ω–æ–≤–ª—è–µ–º –ü–æ–∫—É–ø–∞—Ç–µ–ª—è
        const itemsList = document.getElementById('customer-items');
        if(data.items.length > 0) {
            itemsList.innerHTML = data.items.map(i => `<div class="item-row"><span>${i.n}</span><b>${i.p} ‚ÇΩ</b></div>`).join('');
        } else {
            itemsList.innerHTML = '<p style="text-align:center; opacity:0.3; margin-top:50px;">–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞...</p>';
        }
        document.getElementById('customer-total').innerText = data.total + " ‚ÇΩ";

        // QR –ö–æ–¥
        if(data.total > 0 && data.status === 'paying') {
            document.getElementById('qrcode').innerHTML = '';
            const payLink = window.location.href.split('?')[0] + "?pay=" + data.total;
            new QRCode(document.getElementById("qrcode"), { text: payLink, width: 150, height: 150 });
            document.getElementById('status-text').innerText = "–°–ö–ê–ù_–î–õ–Ø_–û–ü–õ–ê–¢–´";
        }

        // –ï—Å–ª–∏ –æ–ø–ª–∞—á–µ–Ω–æ
        if(data.status === 'paid') {
            document.getElementById('success-overlay').style.display = 'flex';
        }
    });

    // 4. –ü–ï–ß–ê–¢–¨
    function printCheck(app) {
        const logo = "   K-FRESH FOOD\n   ------------\n";
        let body = "";
        currentOrder.items.forEach(i => body += `${i.n.substring(0,15)}.. ${i.p}—Ä\n`);
        const foot = `\n----------\n–ò–¢–û–ì–û: ${currentOrder.total} –†\n–°–ü–ê–°–ò–ë–û –ó–ê –ü–û–ö–£–ü–ö–£!`;
        
        const fullText = logo + body + foot;
        window.location.href = (app === 'FunPrint' ? 'funprint' : 'walkprint') + "://print?text=" + encodeURIComponent(fullText);
    }

    // 5. –õ–û–ì–ò–ö–ê –û–ü–õ–ê–¢–´ (–î–õ–Ø –ö–õ–ò–ï–ù–¢–ê –ü–û QR)
    const params = new URLSearchParams(window.location.search);
    if(params.get('pay')) {
        const amt = params.get('pay');
        document.body.innerHTML = `
            <div style="padding:40px; text-align:center; background:var(--blue); color:white; height:100vh;">
                <h2>–ö-–û–ù–õ–ê–ô–ù –ë–ê–ù–ö</h2>
                <div style="font-size:50px; margin:40px 0;">${amt} ‚ÇΩ</div>
                <input type="number" id="id" placeholder="–¢–≤–æ–π ID" style="width:100%; padding:20px; border-radius:15px; border:none; text-align:center; font-size:24px;">
                <button onclick="pay(${amt})" style="width:100%; padding:25px; background:var(--green); color:white; border:none; border-radius:15px; font-weight:bold; margin-top:20px; font-size:20px;">–û–ü–õ–ê–¢–ò–¢–¨</button>
            </div>`;
    }

    function pay(a) {
        const id = document.getElementById('id').value;
        rtdb.ref('clients').once('value', (snap) => {
            const users = snap.val();
            let uK = null; let uD = null;
            for(let k in users) { if(String(users[k].telegramId) === id) { uD = users[k]; uK = k; } }

            if(uD && uD.balance >= a) {
                rtdb.ref(`clients/${uK}`).update({ balance: uD.balance - a }).then(() => {
                    rtdb.ref('current_check').update({ status: 'paid' });
                    document.body.innerHTML = "<h1 style='text-align:center; margin-top:100px;'>‚úÖ –û–ü–õ–ê–ß–ï–ù–û</h1>";
                });
            } else { alert("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞"); }
        });
    }
</script>
</body>
</html>
