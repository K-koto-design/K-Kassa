<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>K-FRESH POS FIX</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --bg: #F0F4F8; --blue: #2a5298; --dark: #1A1A1A; --green: #27ae60; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--bg); color: var(--dark); }
        .screen { display: none; min-height: 100vh; flex-direction: column; }
        .active { display: flex; }

        /* –î–∏–∑–∞–π–Ω –∫–Ω–æ–ø–æ–∫ */
        .pos-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 15px; padding-bottom: 220px; }
        .item-btn { 
            background: #fff; border: none; padding: 20px; border-radius: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); text-align: left; cursor: pointer;
            -webkit-user-select: none; touch-action: manipulation;
        }
        .item-btn:active { background: #e0e0e0; transform: scale(0.97); }
        .item-btn b { display: block; font-size: 18px; color: var(--blue); margin-top: 5px; }

        .footer { position: fixed; bottom: 0; width: 100%; background: var(--dark); padding: 25px; border-radius: 25px 25px 0 0; color: white; z-index: 10; }
        .btn-pay { width: 100%; padding: 20px; border-radius: 18px; border: none; font-size: 18px; font-weight: 800; background: var(--blue); color: white; }
        
        #qrcode { background: white; padding: 10px; border-radius: 15px; margin: 15px auto; width: 150px; height: 150px; }
    </style>
</head>
<body>

    <div id="scr-cashier" class="screen active">
        <div style="padding: 20px; display:flex; justify-content:space-between; align-items:center;">
            <h2 style="margin:0">–ö-–§–†–ï–® ü•ó</h2>
            <button onclick="setScreen('customer')" style="color:var(--blue); border:none; background:none; font-weight:bold;">–¢–ê–ë–õ–û ‚û°Ô∏è</button>
        </div>
        
        <div class="pos-grid" id="grid"></div>

        <div class="footer">
            <div style="display:flex; justify-content:space-between; font-size:24px; margin-bottom:15px;">
                <span>–ò—Ç–æ–≥–æ:</span> <b id="total-text">0 ‚ÇΩ</b>
            </div>
            <button class="btn-pay" onclick="goPay()">–í–´–°–¢–ê–í–ò–¢–¨ –°–ß–ï–¢</button>
            <div onclick="reset()" style="text-align:center; margin-top:15px; color:#666; font-size:12px;">–û–ß–ò–°–¢–ò–¢–¨ –í–°–Å</div>
        </div>
    </div>

    <div id="scr-customer" class="screen">
        <div style="padding:30px; flex:1; display:flex; flex-direction:column;">
            <h1 onclick="setScreen('cashier')">–í–∞—à –∑–∞–∫–∞–∑</h1>
            <div id="cust-list" style="background:white; border-radius:25px; padding:20px; flex:1; overflow-y:auto;"></div>
            <div style="text-align:center; padding-top:20px;">
                <div style="font-size:45px; font-weight:900;" id="cust-total">0 ‚ÇΩ</div>
                <div id="qrcode"></div>
                <p id="hint">–û–∂–∏–¥–∞–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –±–ª—é–¥...</p>
            </div>
        </div>
    </div>

    <div id="overlay-paid" style="display:none; position:fixed; inset:0; background:var(--green); z-index:100; color:white; flex-direction:column; align-items:center; justify-content:center;">
        <h1 style="font-size:80px; margin:0;">‚úÖ</h1>
        <h2>–û–ü–õ–ê–ß–ï–ù–û</h2>
        <button onclick="print('FunPrint')" style="width:70%; padding:15px; border-radius:10px; border:none; margin:5px;">–ß–µ–∫ FunPrint</button>
        <button onclick="print('WalkPrint')" style="width:70%; padding:15px; border-radius:10px; border:none; margin:5px;">–ß–µ–∫ WalkPrint</button>
        <p onclick="reset()" style="margin-top:20px; text-decoration:underline;">–ù–æ–≤—ã–π –∑–∞–∫–∞–∑</p>
    </div>

<script>
    // 1. –ö–û–ù–§–ò–ì
    const firebaseConfig = { databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const itemsMenu = [
        {n:'–ü–µ–ø–ø–µ—Ä–æ–Ω–∏', p:650, i:'üçï'}, {n:'4 –°—ã—Ä–∞', p:720, i:'üßÄ'},
        {n:'–§–∏–ª–∞–¥–µ–ª—å—Ñ–∏—è', p:480, i:'üç£'}, {n:'–®–∞—É—Ä–º–∞', p:320, i:'üåØ'},
        {n:'–ë—É—Ä–≥–µ—Ä', p:390, i:'üçî'}, {n:'–ö–æ–ª–∞', p:95, i:'ü•§'}
    ];

    let state = { items: [], total: 0, status: 'wait' };

    // 2. –û–¢–†–ò–°–û–í–ö–ê –ú–ï–ù–Æ
    const grid = document.getElementById('grid');
    itemsMenu.forEach((it, idx) => {
        const b = document.createElement('button');
        b.className = 'item-btn';
        b.innerHTML = `<span>${it.i}</span> ${it.n} <b>${it.p} ‚ÇΩ</b>`;
        b.onclick = () => { add(idx); }; // –Ø–≤–Ω–æ–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–ª–∏–∫–∞
        grid.appendChild(b);
    });

    // 3. –§–£–ù–ö–¶–ò–ò
    function add(idx) {
        console.log("–ù–∞–∂–∞—Ç —Ç–æ–≤–∞—Ä:", itemsMenu[idx].n);
        state.items.push(itemsMenu[idx]);
        state.total += itemsMenu[idx].p;
        push();
    }

    function push() {
        db.ref('current_check').set(state).catch(e => console.error("–û—à–∏–±–∫–∞ Firebase:", e));
        updateUI(state);
    }

    function goPay() {
        if(state.total === 0) return;
        state.status = 'paying';
        push();
    }

    function reset() {
        state = { items: [], total: 0, status: 'wait' };
        db.ref('current_check').set(state).then(() => location.reload());
    }

    function setScreen(s) {
        document.querySelectorAll('.screen').forEach(e => e.classList.remove('active'));
        document.getElementById('scr-' + s).classList.add('active');
    }

    function updateUI(data) {
        // –ö–∞—Å—Å–∏—Ä
        document.getElementById('total-text').innerText = data.total + " ‚ÇΩ";
        
        // –ü–æ–∫—É–ø–∞—Ç–µ–ª—å
        const list = document.getElementById('cust-list');
        list.innerHTML = data.items.length ? data.items.map(i => `<div style="display:flex; justify-content:space-between; margin-bottom:8px;">${i.n} <span>${i.p} ‚ÇΩ</span></div>`).join('') : "–ü—É—Å—Ç–æ";
        document.getElementById('cust-total').innerText = data.total + " ‚ÇΩ";

        // QR
        const qr = document.getElementById('qrcode');
        qr.innerHTML = "";
        if(data.status === 'paying') {
            const link = window.location.href.split('?')[0] + "?pay=" + data.total;
            new QRCode(qr, { text: link, width: 150, height: 150 });
            document.getElementById('hint').innerText = "–û–ü–õ–ê–¢–ò–¢–ï –ö–£–ê–†-–ö–û–î–û–ú";
        }

        // –£—Å–ø–µ—Ö
        if(data.status === 'paid') {
            document.getElementById('overlay-paid').style.display = 'flex';
        }
    }

    // –°–õ–£–®–ê–¢–ï–õ–¨
    db.ref('current_check').on('value', (s) => {
        const d = s.val();
        if(d) {
            state = d;
            updateUI(d);
        }
    });

    // –õ–û–ì–ò–ö–ê –û–ü–õ–ê–¢–´ (–ë–ê–ù–ö)
    const url = new URLSearchParams(window.location.search);
    if(url.get('pay')) {
        const sum = url.get('pay');
        document.body.innerHTML = `<div style="padding:50px; text-align:center; background:#1e3c72; color:white; height:100vh;">
            <h2>–ö-–ë–ê–ù–ö</h2><h1 style="font-size:60px;">${sum} ‚ÇΩ</h1>
            <input id="uid" type="number" placeholder="–í–∞—à ID" style="width:100%; padding:20px; border-radius:15px; margin-bottom:10px; font-size:20px;">
            <button onclick="pay(${sum})" style="width:100%; padding:20px; background:var(--green); color:white; border:none; border-radius:15px; font-size:20px; font-weight:bold;">–û–ü–õ–ê–¢–ò–¢–¨</button>
        </div>`;
    }

    function pay(a) {
        const id = document.getElementById('uid').value;
        db.ref('clients').once('value', s => {
            const users = s.val();
            let foundKey = null, foundData = null;
            for(let k in users) { if(String(users[k].telegramId) === id) { foundKey = k; foundData = users[k]; } }
            if(foundData && foundData.balance >= a) {
                db.ref(`clients/${foundKey}`).update({ balance: foundData.balance - a }).then(() => {
                    db.ref('current_check').update({ status: 'paid' });
                    document.body.innerHTML = "<h1 style='color:white; text-align:center; margin-top:100px;'>‚úÖ –û–ü–õ–ê–ß–ï–ù–û</h1>";
                });
            } else { alert("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞!"); }
        });
    }

    function print(app) {
        let t = "K-FRESH\n-------\n";
        state.items.forEach(i => t += i.n + " " + i.p + "—Ä\n");
        t += "-------\n–ò–¢–û–ì–û: " + state.total + "—Ä\n";
        window.location.href = (app === 'FunPrint' ? 'funprint' : 'walkprint') + "://print?text=" + encodeURIComponent(t);
    }
</script>
</body>
</html>
